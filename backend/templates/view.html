{% extends 'base.html' %} {% block title %}Home{% endblock %} {% block content
%} {% import 'includes/header.html' as header %}

<div class="container">
  {{ header.bar('username') }}
  <!-- Create an element where the map will take place -->
</div>
<div class="sidebar_left">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Card Title</h3>
      <span class="collapse-toggle" onclick="toggleCollapse('card1')"
        ><i class="fas fa-chevron-down"></i
      ></span>
    </div>
    <div class="card-body" id="card1">
      <p>This is the body of the card. It contains the main content.</p>
    </div>
    <div class="card-footer">
      <div class="footer-actions">
        <button>Action 1</button>
        <button>Action 2</button>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Ask the AI</h3>
      <span class="collapse-toggle" onclick="toggleCollapse('card2')"
        ><i class="fas fa-chevron-up"></i
      ></span>
    </div>
    <div class="card-body chat-group" id="card2">
      <div>
        <div class="chat-group-conversation"></div>
      <textarea id="userMessage" style="width: 100%; height: 100%;"></textarea>
      <button id="sendMessage">Send</button>
    </div>
    </div>
    <div class="card-footer">
      <div class="footer-actions">
       
      </div>
    </div>
  </div>
</div>
<div class="maincontent">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Card Title</h3>
      <span class="collapse-toggle" onclick="toggleCollapse('card3')"
        ><i class="fas fa-chevron-up"></i
      ></span>
    </div>
    <div class="card-body" id="card3">
      <svg id="my_dataviz" width="400" height="300"></svg>

      <div class="graphContainer"></div>
    </div>
  </div>
</div>
<div class="sidebar_right">
  <div id="details-widget" class="card">
    <div class="card-header">
      <h3 class="card-title">Card Title</h3>
      <span class="collapse-toggle" onclick="toggleCollapse('card4')"
        ><i class="fas fa-chevron-up"></i
      ></span>
    </div>
    <div class="card-body collapse" id="card4">
      <p>This is the body of the card. It contains the main content.</p>
    </div>
    <div class="card-footer">
      <div class="footer-actions">
        <button>Action 1</button>
        <button>Action 2</button>
      </div>
    </div>
  </div>

  <div id="documents-widget" class="card" style="bottom: 0px">
    <div class="card-body" id="card5">
      <div id="upload-container">
        <p>Drag & drop your file here, or</p>
        <button id="upload-button">Browse</button>
        <input type="file" id="file-input" />
      </div>
    </div>
  </div>
</div>
<style>
  .chat-group {
    padding: 4px;
  }
  .chat-group-conversation {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px;
    background-color: rgba(125, 125, 125, 0.9);
    color: white;
    border-radius: 5px;
    overflow-y: auto;
    height: 400px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.1);
  }

  .chat-message {
    padding: 8px;
    background-color: rgba(25, 25, 25, 0.9);
    color: white;
    border-radius: 5px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .chat-group input,
  .chat-group textarea,
  .chat-group button,
  .chat-group select {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    background-color: rgba(25, 25, 25, 0.9);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    appearance: none;
  }
</style>
<script>
  document.getElementById("sendMessage").addEventListener("click",(e)=>{
    const message = document.getElementById("userMessage").value;
    document.getElementById("userMessage").value = "";
    const chatGroup = document.querySelector(".chat-group-conversation");
    const newMessage = document.createElement("div");
    newMessage.classList.add("chat-message");
    newMessage.classList.add("human");
    newMessage.textContent = message;
    chatGroup.appendChild(newMessage);
    chatGroup.scrollTop = chatGroup.scrollHeight;

    async function readAllChunks(readableStream, chatGroup, newMessage) {
      chatGroup.appendChild(newMessage);

      const reader = readableStream.getReader();
      const chunks = [];
        let done, value;
        decoder = new TextDecoder()
        while (!done) {
          ({ value, done } = await reader.read());
          if (done) {
          }
          newMessage.textContent += decoder.decode(value);
          chatGroup.scrollTop = chatGroup.scrollHeight;

        }
    }

    fetch("/ask", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ 'question': message, context:'<here>' }),
    })
      .then(async (response) => {
        const newMessage = document.createElement("div");
        newMessage.classList.add("chat-message");
        newMessage.classList.add("bot");
        await readAllChunks(response.body, chatGroup, newMessage)})      ;
  });


  function toggleCollapse(id) {
    const element = document.getElementById(id);
    if (element.classList.contains("collapse")) {
      element.classList.remove("collapse");
      element.classList.add("expand");
    } else {
      element.classList.remove("expand");
      element.classList.add("collapse");
    }
  }
  // Convert input to graph format
  const nodes = [];
  const links = [];
  const nodeMap = {};



  fetch("/static/unilever.json")
    .then((response) => response.json())
    .then((data) => buildGraph(data));

  function buildGraph(input) {
    // Build nodes and links from input
    input.forEach((entry) => {
      const { subject, predicate, object } = entry;
      if (links.length > 90) return;

      addNode(subject);
      addNode(object);
      links.push({
        source: nodeMap[subject],
        target: nodeMap[object],
        value: 1,
        type: "country",
      });
    });

    createGraph();
  }

  function addNode(name) {
    if (!nodeMap[name]) {
      const newNode = { id: name, group: nodes.length % 10, type: "root" };
      nodes.push(newNode);
      nodeMap[name] = newNode;
    }
  }

  function createGraph() {
    const svg = d3
      .select(".graphContainer")
      .append("svg")
      .attr("width", "100%")
      .attr("height", "90%")
      .call(d3.zoom().on("zoom", zoomed))
      .append("g");

    const link = svg
      .append("g")
      .attr("class", "links")
      .selectAll("line")
      .data(links)
      .enter()
      .append("line")
      .attr("class", "link")
      .attr("stroke-width", (d) => Math.sqrt(d.value) * 2);

    const node = svg
      .append("g")
      .attr("class", "nodes")
      .selectAll("circle")
      .data(nodes)
      .enter()
      .append("circle")
      .attr("class", "node")
      .attr("r", 10)
      .on("click", (event, d) => showDetails(event, d))
      .attr("fill", (d) => d3.schemeCategory10[d.group % 10])
      .call(
        d3
          .drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended)
      );

    const labels = svg
      .append("g")
      .attr("class", "labels")
      .selectAll("text")
      .data(nodes)
      .enter()
      .append("text")
      .attr("dy", -15)
      .text((d) => d.id);

    const simulation = d3
      .forceSimulation(nodes)
      .force(
        "link",
        d3
          .forceLink(links)
          .id((d) => d.id)
          .distance(100)
      )
      .force("charge", d3.forceManyBody())
      .force("center", d3.forceCenter());

    simulation.nodes(nodes).on("tick", ticked);

    simulation.force("link").links(links);

    function ticked() {
      link
        .attr("x1", (d) => d.source.x)
        .attr("y1", (d) => d.source.y)
        .attr("x2", (d) => d.target.x)
        .attr("y2", (d) => d.target.y);

      node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);

      labels.attr("x", (d) => d.x).attr("y", (d) => d.y);
    }

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function showDetails(event, d) {
      const details = document.getElementById("details");
      details.innerHTML = `<h3>${d.id}</h3><p>Group: ${d.group}</p>`;
    }

    function zoomed(event) {
      svg.attr("transform", event.transform);
    }
  }
</script>

<script>
  // The svg
  const svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

  // Map and projection
  const projection = d3
    .geoNaturalEarth1()
    .scale(width / 1.3 / Math.PI)
    .translate([width / 2, height / 2]);

  // Load external data and boot
  d3.json(
    "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"
  ).then(function (data) {
    // Draw the map
    svg
      .append("g")
      .selectAll("path")
      .data(data.features)
      .join("path")
      .attr("fill", "#69b3a2")
      .attr("d", d3.geoPath().projection(projection))
      .style("stroke", "#fff");
  });
</script>

{% endblock %}
